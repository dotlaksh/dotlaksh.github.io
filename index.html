<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChartView 2.0</title>
    <!-- Move scripts to head with defer attribute -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/4.1.1/lightweight-charts.standalone.production.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Rest of the head content remains the same -->
    <style>
        /* Previous CSS styles remain the same */
    </style>
</head>
<body>
    <!-- Previous HTML content remains the same -->
    <script>
        // Wrap the entire script in a function that checks for required libraries
        function initApp() {
            if (typeof LightweightCharts === 'undefined') {
                console.error('LightweightCharts library not loaded. Retrying in 100ms...');
                setTimeout(initApp, 100);
                return;
            }

            if (typeof Papa === 'undefined') {
                console.error('PapaParse library not loaded. Retrying in 100ms...');
                setTimeout(initApp, 100);
                return;
            }

            // Previous JavaScript constants and variables remain the same
            const TIME_PERIODS = {
                '1M': '1mo',
                '3M': '3mo',
                '6M': '6mo',
                'YTD': 'ytd',
                '1Y': '1y',
                '2Y': '2y',
                '5Y': '5y',
                'MAX': 'max'
            };

            const INTERVALS = {
                'D': '1d',
                'W': '1wk',
                'M': '1mo'
            };

            let currentPage = 1;
            let totalPages = 1;
            let currentStocks = [];
            let chart = null;

            // Initialize chart function remains the same
            function initChart() {
                const chartContainer = document.getElementById('chartContainer');
                chart = LightweightCharts.createChart(chartContainer, {
                    layout: {
                        background: { color: '#1E222D' },
                        textColor: '#FFFFFF',
                    },
                    grid: {
                        vertLines: { visible: false },
                        horzLines: { visible: false },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderVisible: false,
                    },
                    timeScale: {
                        borderVisible: false,
                        rightOffset: 5,
                        barSpacing: 5,
                    },
                });

                // Make chart responsive
                window.addEventListener('resize', () => {
                    chart.applyOptions({
                        width: chartContainer.clientWidth,
                        height: chartContainer.clientHeight,
                    });
                });

                // Initial resize
                chart.applyOptions({
                    width: chartContainer.clientWidth,
                    height: chartContainer.clientHeight,
                });
            }

            // Rest of the functions remain the same
            async function loadCSVData(filename) {
                try {
                    const response = await fetch(`data/${filename}.csv`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    
                    return new Promise((resolve) => {
                        Papa.parse(csvText, {
                            header: true,
                            complete: (results) => {
                                resolve(results.data.filter(row => row.symbol && row.name));
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error loading CSV:', error);
                    // Return some default data if CSV fails to load
                    return [
                        { symbol: "RELIANCE", name: "Reliance Industries Ltd." },
                        { symbol: "TCS", name: "Tata Consultancy Services Ltd." },
                        { symbol: "HDFCBANK", name: "HDFC Bank Ltd." }
                    ];
                }
            }

            // Previous functions remain the same
            async function fetchStockData(symbol, period, interval) {
                document.getElementById('loadingIndicator').style.display = 'block';
                try {
                    const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}.NS?range=${period}&interval=${interval}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching stock data:', error);
                    return null;
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            // Rest of the functions remain the same

            // Initialize the application with event handlers
            async function init() {
                initChart();
                
                // Set up event listeners
                document.getElementById('indexSelect').addEventListener('change', (e) => {
                    loadIndex(e.target.value);
                });

                document.getElementById('intervalSelect').addEventListener('change', () => {
                    updatePage();
                });

                document.getElementById('periodSelect').addEventListener('change', () => {
                    updatePage();
                });

                document.getElementById('prevButton').addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        updatePage();
                    }
                });

                document.getElementById('nextButton').addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        updatePage();
                    }
                });

                // Load initial data
                await loadIndex('nifty50');
            }

            // Initialize the app
            init().catch(console.error);
        }

        // Start the application when the DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
