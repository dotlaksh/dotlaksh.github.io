<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Charts</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #1E222D;
      color: white;
    }
    #chartContainer {
      width: 100vw;
      height: 90vh;
    }
    #controls {
      display: flex;
      justify-content: space-around;
      padding: 10px;
      background-color: #333;
    }
    select, button {
      padding: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<div id="controls">
  <select id="stockSelect"></select>
  <button onclick="loadChart()">Load Chart</button>
</div>

<div id="chartContainer"></div>

<script>
  let stockSymbols = [];

  // Load the CSV file and parse it
  async function loadCSV() {
    const response = await fetch('/mnt/data/nifty50.csv');
    const csvText = await response.text();
    const lines = csvText.split('\n').slice(1); // Skip header

    // Parse symbols from CSV and add '.NS' suffix
    stockSymbols = lines.map(line => line.split(',')[0].trim() + '.NS').filter(s => s);
    populateStockSelect();
  }

  // Populate the dropdown with stock symbols
  function populateStockSelect() {
    const stockSelect = document.getElementById('stockSelect');
    stockSelect.innerHTML = stockSymbols.map(symbol =>
      `<option value="${symbol}">${symbol}</option>`).join('');
  }

  // Fetch OHLC data from Yahoo Finance API
  async function fetchOHLCData(symbol) {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=1mo&interval=1d`;
    const response = await fetch(url);
    const data = await response.json();
    const chartData = data.chart.result[0].indicators.quote[0];
    const timestamps = data.chart.result[0].timestamp;

    // Format data for Lightweight Charts
    return timestamps.map((time, i) => ({
      time: time,
      open: chartData.open[i],
      high: chartData.high[i],
      low: chartData.low[i],
      close: chartData.close[i],
      volume: chartData.volume[i],
    }));
  }

  // Load the chart with selected stock data
  async function loadChart() {
    const symbol = document.getElementById('stockSelect').value;
    const ohlcData = await fetchOHLCData(symbol);

    // Create the chart
    const chart = LightweightCharts.createChart(document.getElementById('chartContainer'), {
      width: document.getElementById('chartContainer').clientWidth,
      height: document.getElementById('chartContainer').clientHeight,
      layout: { backgroundColor: '#1E222D', textColor: 'white' },
      grid: { vertLines: { visible: false }, horzLines: { visible: false } },
    });

    const candleSeries = chart.addCandlestickSeries();
    candleSeries.setData(ohlcData);
  }

  // Initialize the page by loading the CSV
  loadCSV();
</script>

</body>
</html>
