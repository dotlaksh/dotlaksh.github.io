<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChartView 2.0</title>
    <!-- Update lightweight-charts to latest stable version and ensure it loads before our script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/4.1.1/lightweight-charts.standalone.production.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>
    <style>
        /* Your existing styles remain unchanged */
        :root {
            --background-color: #1E222D;
            --text-color: #FFFFFF;
            --up-color: #00ff55;
            --down-color: #ed4807;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Rest of your existing styles... */
    </style>
</head>
<body>
    <!-- Your existing HTML structure remains unchanged -->
    <div class="container">
        <!-- ... existing container content ... -->
    </div>

    <script>
        // Wait for both libraries to load before initializing
        function waitForLibraries() {
            return new Promise((resolve) => {
                const checkLibraries = () => {
                    if (window.LightweightCharts && window.Papa) {
                        resolve();
                    } else {
                        setTimeout(checkLibraries, 100);
                    }
                };
                checkLibraries();
            });
        }

        // Your existing constants and variables
        const TIME_PERIODS = {
            '1M': '1mo',
            '3M': '3mo',
            '6M': '6mo',
            'YTD': 'ytd',
            '1Y': '1y',
            '2Y': '2y',
            '5Y': '5y',
            'MAX': 'max'
        };

        const INTERVALS = {
            'D': '1d',
            'W': '1wk',
            'M': '1mo'
        };

        let currentPage = 1;
        let totalPages = 1;
        let currentStocks = [];
        let chart = null;

        // Modified initialization function with error handling
        function initChart() {
            try {
                const chartContainer = document.getElementById('chartContainer');
                if (!chartContainer) throw new Error('Chart container not found');

                chart = LightweightCharts.createChart(chartContainer, {
                    layout: {
                        background: { color: '#1E222D' },
                        textColor: '#FFFFFF',
                    },
                    grid: {
                        vertLines: { visible: false },
                        horzLines: { visible: false },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderVisible: false,
                    },
                    timeScale: {
                        borderVisible: false,
                        rightOffset: 5,
                        barSpacing: 5,
                    },
                });

                // Make chart responsive
                const handleResize = () => {
                    if (chart && chartContainer) {
                        chart.applyOptions({
                            width: chartContainer.clientWidth,
                            height: chartContainer.clientHeight,
                        });
                    }
                };

                window.addEventListener('resize', handleResize);
                handleResize(); // Initial resize

                return true;
            } catch (error) {
                console.error('Error initializing chart:', error);
                document.getElementById('chartContainer').innerHTML = `
                    <div style="color: white; padding: 20px;">
                        Error initializing chart. Please refresh the page or check console for details.
                    </div>
                `;
                return false;
            }
        }

        // Your existing functions remain largely unchanged
        async function loadCSVData(filename) {
            try {
                const response = await fetch(`data/${filename}.csv`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();
                
                return new Promise((resolve) => {
                    Papa.parse(csvText, {
                        header: true,
                        complete: (results) => {
                            resolve(results.data);
                        },
                        error: (error) => {
                            console.error('CSV Parse Error:', error);
                            resolve([]);
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading CSV:', error);
                return [];
            }
        }

        // Modified initialization
        async function init() {
            try {
                // Wait for libraries to load
                await waitForLibraries();
                
                // Initialize chart
                if (!initChart()) return;
                
                // Set up event listeners
                document.getElementById('indexSelect')?.addEventListener('change', (e) => {
                    loadIndex(e.target.value);
                });

                document.getElementById('intervalSelect')?.addEventListener('change', () => {
                    updatePage();
                });

                document.getElementById('periodSelect')?.addEventListener('change', () => {
                    updatePage();
                });

                document.getElementById('prevButton')?.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        updatePage();
                    }
                });

                document.getElementById('nextButton')?.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        updatePage();
                    }
                });

                // Load initial data
                await loadIndex('nifty50');
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('chartContainer').innerHTML = `
                    <div style="color: white; padding: 20px;">
                        Error initializing application. Please refresh the page or check console for details.
                    </div>
                `;
            }
        }

        // Start the application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Rest of your existing functions remain unchanged...
    </script>
</body>
</html>
